# Common Configuration Repository (CCR) - Build Pipeline
# This pipeline runs in the SOURCE CODE repository
# Purpose: Test, build, scan, version, and publish Docker images to Harbor
# Executor: Shell executor with Podman

stages:
  - test
  - build
  - scan
  - publish
  - tag

variables:
  # Harbor Registry Configuration
  HARBOR_REGISTRY: "harbor.k8s.services.cnap-am4.intranet.rws.nl"
  HARBOR_PROJECT: "ivp-integratie-platform"
  IMAGE_NAME: "ccr"

  # Python Configuration
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

  # Security Scanning
  TRIVY_VERSION: "0.48.0"
  TRIVY_CACHE_DIR: "$CI_PROJECT_DIR/.cache/trivy"

  # Versioning
  # For main branch: Use semantic version from VERSION file
  # For feature branches: Use branch name + commit SHA
  VERSION_FILE: "VERSION"

# Cache configuration for faster builds
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .cache/pip
    - .cache/trivy
    - venv/

# ============================================================
# STAGE 1: TEST
# ============================================================

test:unit:
  stage: test
  tags:
    - shell
  before_script:
    - echo "Setting up Python virtual environment..."
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-cov pytest-mock
  script:
    - echo "Running unit tests..."
    - source venv/bin/activate
    - pytest tests/unit/ -v --cov=app --cov-report=term --cov-report=xml:coverage.xml
    - echo "Unit test coverage:"
    - coverage report
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
    expire_in: 1 week
  only:
    - branches
    - merge_requests
    - tags

test:integration:
  stage: test
  tags:
    - shell
  variables:
    MONGO_URI: "mongodb://localhost:27017/ccr_test"
    MONGO_DB_NAME: "ccr_test"
    AUTH_ENABLED: "false"
    FLASK_ENV: "testing"
  before_script:
    - echo "Starting MongoDB container..."
    - podman run -d --name mongodb-test-${CI_PIPELINE_ID} -p 27017:27017 mongo:7.0 || true
    - sleep 5  # Wait for MongoDB to be ready
    - echo "Setting up Python virtual environment..."
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install pytest pytest-mock
  script:
    - echo "Running integration tests..."
    - source venv/bin/activate
    - pytest tests/integration/ -v
  after_script:
    - echo "Cleaning up MongoDB container..."
    - podman stop mongodb-test-${CI_PIPELINE_ID} || true
    - podman rm mongodb-test-${CI_PIPELINE_ID} || true
  artifacts:
    reports:
      junit: test-results.xml
    paths:
      - test-results.xml
    expire_in: 1 week
  only:
    - branches
    - merge_requests
    - tags

test:lint:
  stage: test
  tags:
    - shell
  before_script:
    - echo "Setting up Python virtual environment..."
    - python3 -m venv venv
    - source venv/bin/activate
    - pip install flake8 black pylint
  script:
    - echo "Running code quality checks..."
    - source venv/bin/activate
    - flake8 app/ --max-line-length=120 --exclude=venv,__pycache__,.git || true
    - black app/ --check --line-length=120 || true
    - pylint app/ --disable=C0111,R0903 || true
  allow_failure: true
  only:
    - branches
    - merge_requests

# ============================================================
# STAGE 2: BUILD
# ============================================================

build:podman:
  stage: build
  tags:
    - shell
  before_script:
    - echo "Determining version..."
    # For main/master branch, use VERSION file
    - |
      if [[ "$CI_COMMIT_BRANCH" == "main" || "$CI_COMMIT_BRANCH" == "master" ]]; then
        if [ -f "$VERSION_FILE" ]; then
          export IMAGE_TAG=$(cat $VERSION_FILE)
          echo "Using version from VERSION file: $IMAGE_TAG"
        else
          echo "ERROR: VERSION file not found for main branch"
          exit 1
        fi
      else
        # For feature branches, use branch-commit format
        export IMAGE_TAG="${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"
        echo "Using branch-based version: $IMAGE_TAG"
      fi
    - echo "Building image: ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}"
  script:
    - echo "Building container image with Podman..."
    - podman build -t ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG} .
    - podman tag ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG} ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:latest
    - echo "Saving image for scanning..."
    - podman save ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG} -o image.tar
  artifacts:
    paths:
      - image.tar
    expire_in: 1 day
  only:
    - branches
    - merge_requests
    - tags
  dependencies:
    - test:unit
    - test:integration

# ============================================================
# STAGE 3: SECURITY SCAN
# ============================================================

scan:trivy:
  stage: scan
  tags:
    - shell
  variables:
    TRIVY_NO_PROGRESS: "true"
    TRIVY_CACHE_DIR: "$CI_PROJECT_DIR/.cache/trivy"
  before_script:
    - export IMAGE_TAG=$(if [[ "$CI_COMMIT_BRANCH" == "main" || "$CI_COMMIT_BRANCH" == "master" ]]; then cat $VERSION_FILE; else echo "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"; fi)
    - echo "Ensuring Trivy is installed..."
    - |
      if ! command -v trivy &> /dev/null; then
        echo "Installing Trivy..."
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v${TRIVY_VERSION}
      fi
  script:
    - echo "Scanning image for vulnerabilities..."
    - trivy image --input image.tar --format json --output trivy-report.json
    - trivy image --input image.tar --severity CRITICAL,HIGH --exit-code 0
    - echo "Vulnerability scan complete. Review trivy-report.json for details."
  artifacts:
    reports:
      container_scanning: trivy-report.json
    paths:
      - trivy-report.json
    expire_in: 30 days
  dependencies:
    - build:podman
  only:
    - branches
    - merge_requests
    - tags

scan:secrets:
  stage: scan
  tags:
    - shell
  before_script:
    - echo "Ensuring TruffleHog is available..."
    - |
      if ! command -v trufflehog &> /dev/null; then
        echo "Running TruffleHog via Podman container..."
      fi
  script:
    - echo "Scanning for secrets in git history..."
    - podman run --rm -v "$CI_PROJECT_DIR:/repo" trufflesecurity/trufflehog:latest git file:///repo --json --no-update > trufflehog-report.json || true
    - |
      if [ -s trufflehog-report.json ]; then
        echo "WARNING: Potential secrets found in repository!"
        cat trufflehog-report.json
      else
        echo "No secrets detected."
      fi
  artifacts:
    paths:
      - trufflehog-report.json
    expire_in: 30 days
  allow_failure: true
  only:
    - branches
    - merge_requests

# ============================================================
# STAGE 4: PUBLISH
# ============================================================

publish:harbor:
  stage: publish
  tags:
    - shell
  before_script:
    - export IMAGE_TAG=$(if [[ "$CI_COMMIT_BRANCH" == "main" || "$CI_COMMIT_BRANCH" == "master" ]]; then cat $VERSION_FILE; else echo "${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}"; fi)
    - echo "Publishing image: ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}"
    - echo "Logging into Harbor..."
    - echo "${HARBOR_PASSWORD}" | podman login ${HARBOR_REGISTRY} -u ${HARBOR_USERNAME} --password-stdin
  script:
    - echo "Loading container image..."
    - podman load -i image.tar
    - echo "Pushing image to Harbor..."
    - podman push ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}
    - |
      if [[ "$CI_COMMIT_BRANCH" == "main" || "$CI_COMMIT_BRANCH" == "master" ]]; then
        echo "Pushing 'latest' tag..."
        podman push ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:latest
      fi
    - echo "Image published successfully!"
    - echo "Image: ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}"
  after_script:
    - echo "Logging out from Harbor..."
    - podman logout ${HARBOR_REGISTRY} || true
  dependencies:
    - build:podman
    - scan:trivy
  only:
    - main
    - master
    - tags
  when: manual

# ============================================================
# STAGE 5: TAG & VERSION
# ============================================================

tag:release:
  stage: tag
  tags:
    - shell
  before_script:
    - export IMAGE_TAG=$(cat $VERSION_FILE)
    - git config user.name "${GITLAB_USER_NAME}"
    - git config user.email "${GITLAB_USER_EMAIL}"
  script:
    - echo "Creating git tag v${IMAGE_TAG}..."
    - git tag -a "v${IMAGE_TAG}" -m "Release version ${IMAGE_TAG}"
    - git push https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git "v${IMAGE_TAG}"
    - echo "Tag v${IMAGE_TAG} created and pushed."
  only:
    - main
    - master
  when: manual
  dependencies: []

# ============================================================
# WORKFLOW RULES
# ============================================================

workflow:
  rules:
    # Run pipeline for merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # Run pipeline for main/master branch
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
    # Run pipeline for tags
    - if: '$CI_COMMIT_TAG'
    # Run pipeline for feature branches
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - if: '$CI_COMMIT_BRANCH'
