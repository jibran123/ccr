# Common Configuration Repository (CCR) - Helm Chart

This Helm chart deploys the Common Configuration Repository (CCR) application on Kubernetes.

## Prerequisites

- Kubernetes 1.24+
- Helm 3.8+
- kubectl configured to access your cluster
- Harbor registry access (for image pulling)

## Chart Structure

```
ccr/
├── Chart.yaml                 # Chart metadata
├── values.yaml                # Default values
├── values-dev.yaml            # Development environment
├── values-tst.yaml            # Test environment
├── values-acc.yaml            # Acceptance environment
├── values-prd.yaml            # Production environment
├── templates/                 # Kubernetes manifest templates
│   ├── _helpers.tpl          # Template helper functions
│   ├── deployment.yaml       # Flask deployment
│   ├── service.yaml          # Flask service
│   ├── configmap.yaml        # Configuration
│   ├── secret.yaml           # Secrets
│   ├── statefulset.yaml      # MongoDB StatefulSet
│   ├── mongodb-service.yaml  # MongoDB service
│   ├── mongodb-headless-service.yaml  # MongoDB headless
│   ├── pvc.yaml              # Backup PVC
│   ├── hpa.yaml              # Horizontal Pod Autoscaler
│   ├── ingress.yaml          # Ingress resource
│   ├── serviceaccount.yaml   # Service Account
│   └── NOTES.txt             # Post-install notes
└── README.md                  # This file
```

## Quick Start

### 1. Install Chart (Development)

```bash
helm install ccr ./helm/ccr \
  --namespace ccr-dev \
  --create-namespace \
  --values ./helm/ccr/values-dev.yaml
```

### 2. Install Chart (Production)

```bash
helm install ccr ./helm/ccr \
  --namespace ccr-prd \
  --create-namespace \
  --values ./helm/ccr/values-prd.yaml \
  --set image.tag=1.0.0
```

### 3. Upgrade Existing Release

```bash
helm upgrade ccr ./helm/ccr \
  --namespace ccr-prd \
  --values ./helm/ccr/values-prd.yaml \
  --set image.tag=1.1.0
```

### 4. Rollback

```bash
# View history
helm history ccr -n ccr-prd

# Rollback to previous version
helm rollback ccr -n ccr-prd

# Rollback to specific revision
helm rollback ccr 3 -n ccr-prd
```

### 5. Uninstall

```bash
helm uninstall ccr -n ccr-prd
```

## Configuration

### Essential Parameters

| Parameter | Description | Default | Required |
|-----------|-------------|---------|----------|
| `global.environment` | Environment name | `dev` | Yes |
| `image.registry` | Harbor registry URL | `harbor.yourcompany.com` | Yes |
| `image.repository` | Image repository path | `ccr/ccr` | Yes |
| `image.tag` | Image tag (version) | `2.0.0` | Yes (production) |
| `flask.replicaCount` | Number of Flask replicas | `2` | No |
| `mongodb.enabled` | Enable MongoDB deployment | `true` | No |

### Environment-Specific Values

#### Development (`values-dev.yaml`)
- Single replica
- Disabled authentication
- NodePort service
- Minimal resources
- No auto-scaling

#### Test (`values-tst.yaml`)
- 2 replicas
- Enabled authentication
- Ingress with staging TLS
- Production-like resources
- Auto-scaling enabled (2-4)

#### Acceptance (`values-acc.yaml`)
- 2 replicas
- Full security enabled
- Ingress with production TLS
- Production resources
- Auto-scaling enabled (2-5)
- Monitoring enabled

#### Production (`values-prd.yaml`)
- 3 replicas (minimum)
- Full security + network policies
- Premium storage
- Higher resource limits
- Auto-scaling enabled (3-10)
- Monitoring + alerting
- External secrets integration

### Secrets Management

#### For Development/Test (Helm-managed)
Secrets are generated by Helm or provided in values file:

```yaml
flask:
  secrets:
    secretKey: "base64encodedvalue"
    jwtSecretKey: "base64encodedvalue"
    jwtAdminKey: "base64encodedvalue"
```

#### For Production (External Secrets)
Use Azure Key Vault or HashiCorp Vault:

```yaml
externalSecrets:
  enabled: true
  backendType: azureKeyVault
  vaultPath: "ccr-prod"
  keys:
    - secretKey
    - jwtSecretKey
    - jwtAdminKey
```

## Testing the Chart

### 1. Validate Chart Syntax

```bash
helm lint ./helm/ccr
```

### 2. Dry Run Install

```bash
helm install ccr ./helm/ccr \
  --namespace ccr-dev \
  --values ./helm/ccr/values-dev.yaml \
  --dry-run --debug
```

### 3. Template Rendering

```bash
# Render all templates with default values
helm template ccr ./helm/ccr

# Render with specific environment
helm template ccr ./helm/ccr \
  --values ./helm/ccr/values-prd.yaml \
  --set image.tag=1.0.0

# Save rendered templates to file
helm template ccr ./helm/ccr \
  --values ./helm/ccr/values-dev.yaml \
  > rendered-manifests.yaml
```

### 4. Validate Against Kubernetes

```bash
helm template ccr ./helm/ccr \
  --values ./helm/ccr/values-dev.yaml \
  | kubectl apply --dry-run=client -f -
```

## Common Use Cases

### Deploy Specific Version

```bash
helm upgrade --install ccr ./helm/ccr \
  --namespace ccr-prd \
  --values ./helm/ccr/values-prd.yaml \
  --set image.tag=1.2.3
```

### Scale Manually

```bash
helm upgrade ccr ./helm/ccr \
  --namespace ccr-prd \
  --values ./helm/ccr/values-prd.yaml \
  --set flask.replicaCount=5 \
  --reuse-values
```

### Disable MongoDB (Use External)

```bash
helm upgrade ccr ./helm/ccr \
  --namespace ccr-prd \
  --values ./helm/ccr/values-prd.yaml \
  --set mongodb.enabled=false \
  --set flask.env.mongoHost=external-mongodb.yourcompany.com
```

### Enable Ingress

```bash
helm upgrade ccr ./helm/ccr \
  --namespace ccr-prd \
  --values ./helm/ccr/values-prd.yaml \
  --set ingress.enabled=true \
  --set ingress.hosts[0].host=ccr.yourcompany.com
```

## Troubleshooting

### Chart Fails to Install

1. **Check Helm version:**
   ```bash
   helm version
   ```

2. **Validate chart syntax:**
   ```bash
   helm lint ./helm/ccr
   ```

3. **Check rendered templates:**
   ```bash
   helm template ./helm/ccr --debug
   ```

### Pods Not Starting

1. **Check pod events:**
   ```bash
   kubectl describe pod <pod-name> -n ccr-prd
   ```

2. **Check logs:**
   ```bash
   kubectl logs <pod-name> -n ccr-prd
   ```

3. **Verify image exists:**
   ```bash
   # Check if image is accessible
   kubectl run test-image --image=harbor.yourcompany.com/ccr/ccr:1.0.0 --rm -it -- /bin/bash
   ```

### HPA Not Scaling

1. **Check metrics-server:**
   ```bash
   kubectl get deployment metrics-server -n kube-system
   ```

2. **Check HPA status:**
   ```bash
   kubectl get hpa ccr-flask -n ccr-prd
   kubectl describe hpa ccr-flask -n ccr-prd
   ```

### Ingress Not Working

1. **Check ingress controller:**
   ```bash
   kubectl get pods -n ingress-nginx
   ```

2. **Check ingress resource:**
   ```bash
   kubectl describe ingress ccr -n ccr-prd
   ```

3. **Check service endpoints:**
   ```bash
   kubectl get endpoints ccr-flask -n ccr-prd
   ```

## Advanced Configuration

### Custom Values File

Create a custom values file:

```yaml
# custom-values.yaml
image:
  tag: "1.5.0"

flask:
  replicaCount: 4
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

ingress:
  enabled: true
  hosts:
    - host: ccr-custom.yourcompany.com
      paths:
        - path: /
          pathType: Prefix
```

Use it:
```bash
helm upgrade --install ccr ./helm/ccr \
  --namespace ccr-prd \
  --values ./helm/ccr/values-prd.yaml \
  --values custom-values.yaml
```

### Override Individual Values

```bash
helm upgrade --install ccr ./helm/ccr \
  --namespace ccr-prd \
  --values ./helm/ccr/values-prd.yaml \
  --set image.tag=1.6.0 \
  --set flask.replicaCount=5 \
  --set flask.env.authEnabled=true
```

## CI/CD Integration

### GitLab CI Example

```yaml
deploy:prd:
  stage: deploy
  image: alpine/helm:latest
  script:
    - helm upgrade --install ccr ./helm/ccr \
        --namespace ccr-prd \
        --values ./helm/ccr/values-prd.yaml \
        --set image.tag=${CI_COMMIT_TAG} \
        --wait \
        --timeout 5m
  only:
    - tags
  when: manual
```

## Best Practices

1. **Always specify image tag in production**
   - Never use `latest` in production
   - Use semantic versioning (e.g., `1.2.3`)

2. **Use separate values files per environment**
   - Don't modify `values.yaml` directly
   - Create environment-specific overrides

3. **Test changes in lower environments first**
   - dev → tst → acc → prd

4. **Review rendered templates before applying**
   ```bash
   helm template ./helm/ccr --values values-prd.yaml | less
   ```

5. **Use `--wait` flag for deployments**
   - Ensures pods are healthy before marking as success
   ```bash
   helm upgrade --install ccr ./helm/ccr --wait --timeout 5m
   ```

6. **Keep helm releases atomic**
   - Use `--atomic` flag to rollback on failure
   ```bash
   helm upgrade --install ccr ./helm/ccr --atomic
   ```

## Maintenance

### Update Chart Version

Edit `Chart.yaml`:
```yaml
version: 1.1.0  # Increment for chart changes
appVersion: "2.0.0"  # Update for application version changes
```

### Package Chart

```bash
helm package ./helm/ccr
# Creates: ccr-1.0.0.tgz
```

### Push to Harbor (Helm Registry)

```bash
# Login to Harbor
helm registry login harbor.yourcompany.com

# Package and push
helm package ./helm/ccr
helm push ccr-1.0.0.tgz oci://harbor.yourcompany.com/ccr
```

### Install from Harbor

```bash
helm install ccr oci://harbor.yourcompany.com/ccr/ccr \
  --version 1.0.0 \
  --namespace ccr-prd \
  --values values-prd.yaml
```

## Support

- **Issues:** https://github.com/yourcompany/ccr-deployment/issues
- **Documentation:** https://github.com/yourcompany/ccr-deployment
- **Contact:** jibran@yourcompany.com

## License

Proprietary - Internal Use Only
